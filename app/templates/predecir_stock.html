{% extends "layaout.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Predicción de Stock Semanal</h1>
    <form onsubmit="event.preventDefault(); mostrarPrediccion();">
        <div class="mb-3">
            <label for="producto" class="form-label">Producto</label>
            <select class="form-select" id="producto">
                <option>Mayonesa Alacena</option>
                <option>Aceite Primor</option>
                <option>Fideos Victorio</option>
            </select>
        </div>
        <div class="mb-3">
          <label class="form-label">Selecciona semana</label>
          <div id="calendario"></div>
        </div>
        <button type="submit" class="btn btn-primary">Predecir</button>
    </form>
    <hr>
    <h3>Resultado de la predicción</h3>
    <div id="reporte-prediccion">
      <p id="resultado" style="font-size:1.4rem; font-weight:500;">
          Selecciona un producto y una semana para ver la predicción.
      </p>
      <div id="imagen-producto"></div>
    </div>
    <button type="button" class="btn btn-secondary mt-3" onclick="imprimirReporte()">Generar reporte</button>
</div>

<!-- Incluye estos scripts al final del body o en tu base -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/weekSelect/weekSelect.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/weekSelect/weekSelect.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
<script>
  let semanaSeleccionada = null;

  function getNextMonday() {
    const today = new Date();
    const day = today.getDay();
    const diff = (day === 0 ? 1 : 8 - day);
    today.setDate(today.getDate() + diff);
    today.setHours(0,0,0,0);
    return today;
  }

  function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    return weekNo;
  }

  flatpickr("#calendario", {
    locale: {
      ...flatpickr.l10ns.es,
      firstDayOfWeek: 1
    },
    weekNumbers: true,
    inline: true,
    minDate: getNextMonday(),
    plugins: [
      new weekSelect({})
    ],
    onChange: function(selectedDates, dateStr, instance) {
      semanaSeleccionada = selectedDates[0];
    }
  });

  function mostrarPrediccion() {
    const producto = document.getElementById('producto').value;
    const imagenDiv = document.getElementById('imagen-producto');
    const resultado = document.getElementById('resultado');
    if (!producto || !semanaSeleccionada) {
      resultado.innerHTML = 
        `<span class="badge bg-warning">Selecciona un producto y una semana futura.</span>`;
      imagenDiv.innerHTML = "";
      return;
    }
    const year = semanaSeleccionada.getFullYear();
    const week = getWeekNumber(semanaSeleccionada);

    let prediccion = {
        "Mayonesa Alacena": [120, 110, 130, 125],
        "Aceite Primor": [80, 90, 85, 95],
        "Fideos Victorio": [60, 70, 65, 75]
    };
    let stock = prediccion[producto][week % 4];

    resultado.innerHTML = 
        `Pedido estimado para <strong>${producto}</strong> en la semana <strong>${week}</strong> de <strong>${year}</strong>: 
        <span class="badge bg-success" style="font-size:1.6rem; font-weight:bold; padding:10px 18px;">${stock} unidades</span>`;

    let rutas = {
      "Mayonesa Alacena": "/static/img/predicciones/prophet1.png",
      "Aceite Primor": "/static/img/predicciones/prophet2.png",
      "Fideos Victorio": "/static/img/predicciones/prophet3.png"
    };
    imagenDiv.innerHTML = `<div style="display:flex; justify-content:center; margin-top:20px;">
      <img src="${rutas[producto]}" alt="${producto}" style="max-width:450px; width:100%; height:auto; border:1px solid #ddd; border-radius:8px; box-shadow:0 2px 8px #0001;">
    </div>`;
  }

  function imprimirReporte() {
    const contenido = document.getElementById('reporte-prediccion').innerHTML;
    const ventana = window.open('', '', 'height=600,width=800');
    ventana.document.write(`
      <html>
        <head>
          <title>Reporte de Predicción</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 30px; }
            .badge { display: inline-block; padding: 10px 18px; font-size: 1.6rem; font-weight: bold; background: #198754; color: #fff; border-radius: 0.5rem; }
            img { max-width: 450px; width: 100%; height: auto; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 2px 8px #0001; display: block; margin: 20px auto; }
            p { font-size: 1.4rem; font-weight: 500; }
          </style>
        </head>
        <body>
          <h2>Reporte de Predicción de Stock Semanal</h2>
          ${contenido}
        </body>
      </html>
    `);
    ventana.document.close();
    ventana.focus();

    // Espera a que las imágenes se carguen antes de imprimir
    ventana.onload = function() {
      const imgs = ventana.document.images;
      if (imgs.length === 0) {
        ventana.print();
        ventana.close();
      } else {
        let loaded = 0;
        for (let img of imgs) {
          img.onload = img.onerror = function() {
            loaded++;
            if (loaded === imgs.length) {
              ventana.print();
              ventana.close();
            }
          };
        }
      }
    };
  }
</script>
{% endblock %}